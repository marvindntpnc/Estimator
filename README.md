# Estimator — формирование смет по Excel-тарификатору

Веб‑приложение для импорта прайс‑листов из Excel (тарификатор) и быстрого формирования смет на ремонтные работы и материалы. Позволяет загружать и актуализировать позиции из Excel, искать и отбирать позиции, собирать смету, а затем выгружать готовый расчет в Excel с фирменной шапкой.

## Основные возможности

- **Импорт тарификатора из Excel**:
  - Поддержка типов тарификаторов: **FUL** (материалы и услуги) и **KTO**
  - Для FUL разбираются 2 листа: 1 — материалы, 2 — услуги
  - Автоматическое создание категорий и подкатегорий из колонок Excel
  - Обновление прайса: при повторной загрузке для выбранного типа старые записи удаляются и загружаются новые

- **Поиск и отбор позиций**:
  - Поиск по наименованию с пагинацией
  - Отдельные списки для FUL и KTO в форме подбора

- **Формирование смет**:
  - Выбор позиций и количеств, задание курса валюты, флага скидок, номера и клиента
  - Сохранение сметы и ее состава в БД

- **Экспорт сметы в Excel**:
  - Генерация XLSX с логотипом и шапкой, автоматические итоги по позициям
  - Разделение материалов и услуг, учет категорий и подкатегорий

- **Структурированная доменная модель**:
  - `TarifficatorItem`, `Category`, `Estimate`, `EstimateItem` + перечисления (валюта, ед. изм., типы)

## Технологии

- **ASP.NET Core MVC (.NET 9.0)**
- **Entity Framework Core** + **SQL Server**
- **ClosedXML** для чтения/генерации Excel
- Паттерны **Repository** и **Services**, фабрики моделей для ViewModel‑ов
- UI на Razor Views, в `wwwroot` есть **Bootstrap** и **jQuery**

## Как это полезно в реальной работе

- **Быстрое составление смет**: импортируете актуальный Excel‑прайс от поставщика/подрядчика, подбираете позиции и выгружаете готовую смету
- **Актуальность цен**: любое обновление Excel моментально отражается в системе
- **Стандартизация**: единый формат выгрузки сметы в XLSX с фирменной шапкой и структурой
- **Категоризация**: автоматическое распределение по категориям/подкатегориям упрощает навигацию

## Архитектура и ключевые компоненты

### Контроллер: `HomeController`
- `UploadTarifficator(file, tarifficatorType)` — импорт Excel в БД
- `EstimateForming` (GET/POST) — форма подбора позиций, возвращает модель с FUL/KTO
- `CreateEstimate(items, title, number, currencyRate, customerName, isDiscounts)` — сохранение сметы
- `DownloadEstimate(id)` — генерация и отдача Excel‑сметы

### Сервисы
- `TarifficatorService` — парсинг Excel (ClosedXML), категории, поиск, пагинация
- `EstimateService` — создание, выборка и сортировка позиций сметы
- `RepositoryService<TEntity>` — универсальный репозиторий (EF Core)

### Фабрики моделей
- `TarifficatorModelFactory` — преобразование `TarifficatorItem` в `TarrificatorItemModel`, сборка модели формы подбора
- `EstimateModelFactory` — представление списка смет и их позиций

### Данные
- `ApplicationContext` (EF Core): `TarifficatorItems`, `Categories`, `Estimates`, `EstimateItems`
- Индексы и каскадное удаление настроены в `OnModelCreating`

## Формат Excel, ожидаемый приложением

### FUL / Материалы (лист 1)
- A — код
- B — категория
- C — подкатегория
- D — наименование
- E — описание
- F — ед. изм.
- G — валюта
- I — цена

### FUL / Услуги (лист 2)
- A — код
- B — категория
- C — наименование
- D — описание
- E — ед. изм.
- F — валюта
- H — цена

### KTO
- Аналогично, единый лист, с колонками кода/категорий/описания/ед. изм./валюты/цены

**Примечание**: Цены парсятся как decimal с инвариантной культурой; строки с заголовками (содержат «поз») пропускаются.

## Быстрый старт

### Предварительные требования
- Установите **.NET SDK 9.0** и **SQL Server**
- Проверьте строку подключения в `appsettings.json` (`ConnectionStrings:DefaultConnection`)

### Миграции БД
В проекте уже есть миграции в `Migrations/`. Примените их:
```powershell
dotnet tool install --global dotnet-ef
dotnet ef database update
```

### Запуск
```powershell
dotnet run
```
Приложение доступно по адресу `https://localhost:xxxx/`

### Рабочий процесс
1. Загрузите Excel‑тарификатор (FUL/KTO)
2. Откройте форму подбора, найдите нужные позиции, укажите количества
3. Создайте смету и скачайте Excel

## Конфигурация и пути

- Логотип для Excel: `Excel/assets/images/logo.png` (используется при генерации)
- Маршрут по умолчанию: `{controller=Home}/{action=Index}/{id?}`
- DI/EF Core настраиваются в `Program.cs`

## Структура проекта

```
Estimator/
├── Controllers/
│   └── HomeController.cs          # Основной контроллер
├── Services/
│   ├── TarifficatorService.cs     # Работа с тарификатором
│   ├── EstimateService.cs         # Работа со сметами
│   ├── RepositoryService.cs       # Универсальный репозиторий
│   └── EnumHelper.cs              # Вспомогательные методы
├── Factories/
│   ├── TarifficatorModelFactory.cs # Фабрика моделей тарификатора
│   └── EstimateModelFactory.cs    # Фабрика моделей смет
├── Domain/
│   ├── TarifficatorItem.cs        # Позиция тарификатора
│   ├── Category.cs                # Категория
│   ├── Estimate.cs                # Смета
│   ├── EstimateItem.cs            # Позиция сметы
│   └── Enums/                     # Перечисления
├── Data/
│   └── ApplicationContext.cs      # Контекст EF Core
├── Models/                        # ViewModels
├── Views/                         # Razor-представления
├── wwwroot/                       # Статические ресурсы
└── Migrations/                    # Миграции БД
```

## Примечания

- Валидация структуры Excel должна соответствовать ожидаемым колонкам по типу тарификатора
- При повторной загрузке тарификатора для выбранного типа старые записи удаляются
- Экспорт сметы выполнен на ClosedXML, структура листа может настраиваться в `HomeController.DownloadEstimate`
- Поддерживаемые валюты: RUB, EUR, USD, CNY
- Поддерживаемые единицы измерения: шт., кг., л., м.п., м², м³, см., коэфф., тн., н/ч, бал, комплект
